---
title: "diffobj - Diffs for R Objects"
author: "Brodie Gaslam"
output:
    function(...) rmarkdown::html_vignette(..., md_extensions="-markdown_in_html_blocks"):
        toc: true
        css: styles.css

vignette: >
  %\VignetteIndexEntry{diffobj}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

## Introduction

`diffobj` uses the same comparison mechanism used by `git diff` and `diff` to highlight differences between _rendered_ R objects:

```{r, results="asis"}
library(diffobj)
a <- b <- matrix(1:100, ncol=2)
b[c(20, 45, 68)] <- 999
diffPrint(target=a, current=b)
```

`diffobj` comparisons work best when objects have some similarities, or when they are relatively small.  The package was originally developed to help diagnose failed unit tests by comparing test results to reference objects in a human-friendly manner.

If your terminal supports formatting through ANSI escape sequences, `diffobj` will output colored diffs to the terminal.  If not, it will output colored diffs to your browser.

## Interpreting Diffs

### Shortest Edit Script

The output from `diffobj` is a visual representation of the Shotest Edit Script (SES).  An SES is the shortest set of deletion and insertion instructions for converting one sequence of elements into another.  In our case, the elements are lines of text.  We encode the instructions to convert `a` to `b` by deleting lines from `a` (in yellow) and inserting new ones from `b` (in blue).

### Diff Structure

The first line of our diff output acts as a legend to the diff by associating the colors and symbols used to represent differences present in each object with the name of the object:

```{r, results="asis", echo=FALSE}
diffPrint(target=a, current=b)[1]
```

After the legend come the hunks, which are portions of the objects that have differences with nearby matching lines provided for context:

```{r, results="asis", echo=FALSE}
diffPrint(target=a, current=b)[2:9]
```

At the top of the hunk is the hunk header: this tells us that the first displayed hunk (including context lines), starts at line 17 and spans 7 lines for both `a` and `b`.  These are display lines, not object row indices, which is why the first row shown of the matrix is row 16.  You might have also noticed that the line after the hunk header is out of place:

```{r, results="asis", echo=FALSE}
diffPrint(target=a, current=b)[3]
```

This is a special context line that is not technically part of the hunk, but is shown nonetheless because it is useful in helping understand the data.  The line is styled differently to highlight that it is not part of the hunk.  Since it is not part of the hunk, it is not accounted for in the hunk header.  See `?guideLines` for more details.

The actual mismatched lines are highlighted in the colors of the legend, with additional visual cues in the gutters should colors be unavailable:

```{r, results="asis", echo=FALSE}
diffPrint(target=a, current=b)[6]
```

`diffobj` uses a line by line diff to identify which portions of each of the objects are mismatches, so even if only part of a line mismatches it will be considered different.  Subsequent to the line diff, `diffobj` will run a word diff within each paired set of insertions and deletions to attempt to identify which components of the line chnaged.  Here you can see here the number `68` has been replaced by `999`.

### Idiosyncracies

At times diffs will produce outputs that are superficially unintuitive.  For example:

```{r, results="asis"}
diffPrint(t(matrix(1:12, 3)), t(matrix(2:13, 3)))
```

Row headers such as `[2,]` are highlighted as being differences, when clearly they have matching values in both objects.  What is happening here is that the diff algorithm prefers to match the `4` from row 2 in the left object to the `4` from row 1 in the right.  To do that the algorithm must delete the `[2,]`, match the `4`, and re-insert the `[2,]`.  Anytime a token is "moved" in this way it will show up as the combination of a deletion and an insertion, which is why both `[2,]` tokens are highlighted as changed.

## Other Diff Functions

### Compare Structure

For complex objects it is often useful to compare structures:

```{r, results="asis"}
mdl1 <- lm(Sepal.Length ~ Sepal.Width, iris)
mdl2 <- lm(Sepal.Length ~ Sepal.Width + Species, iris.3)
diffStr(mdl1$qr, mdl2$qr, line.limit=50)
```

If you specify a `line.limit` with `diffStr` it will fold nested levels in order to fit under `line.limit`, so long as there remain visible differences.  If you prefer to see all the differences you can leave `line.limit` unspecified.

### Function Overview

There are a variety of related functions for comparing objects:

* `diffPrint`: use the `print`/`show` output
* `diffStr`: use the output of `str`
* `diffObj`: pick between `print`/`show` and `str` depending on which provides the "best" overview of differences
* `diffChr`: use the contents of character vectors instead of their display representations
* `diffFile`: compare the text content of two files
* `diffCsv`: load two CSV files into data frames and compare the data frames with `diffPrint`
* `diffDeparse`: compare the deparsed objects
* `ses`: compute the element by element shortest edit script on two character vectors

Note the `diff*` functions use lowerCamelCase in keeping with S4 method name convention, whereas the package name itself is all lower case.

## Controlling Diffs and Their Appearance

### Parameters

The `diff*` family of methods has an extensive set of parameters that allow you to fine tune how the diff is applied and displayed.  We will review some of the major ones in this section.  For a full description see `?diffPrint`.

We have taken great care to pick sensible defaults for each of these parameters.  Should these defauls be displeasing, you may change them either by specifying your own values for your parameters, or by specifying the corresponding `diffobj.*` option that defines the default.

### Display Mode

There are three built-in display modes that are similar to those found in GNU `diff`: "sidebyside", "unified", and "context".  For example, by varying the `mode` parameter with:

```{r, results="asis", eval=FALSE}
x <- y <- letters[24:26]
y[2] <- "GREMLINS"
diffChr(x, y)
```

we get:

<table>
<tr><th>mode="sidebyside"<th>mode="unified"<th>mode="context"
<tr style="vertical-align: top">
<td>
```{r, results="asis", echo=FALSE}
x <- y <- letters[24:26]
y[2] <- "GREMLINS"
diffChr(x, y, mode="sidebyside")
```
<td>
```{r, results="asis", echo=FALSE}
x <- y <- letters[24:26]
y[2] <- "GREMLINS"
diffChr(x, y, mode="unified")
```
<td>
```{r, results="asis", echo=FALSE}
x <- y <- letters[24:26]
y[2] <- "GREMLINS"
diffChr(x, y, mode="context")
```
</table>

By default `diffobj` will try to use `mode="sidebyside"` if reasonable given display width, and otherwise will switch to `mode="unified"`.  You can always force a particular display style by specifying it with the `mode` argument.

### Color Mode

The default color mode uses yellow and blue to symbolize deletions and insertions for accessibility to dichromats.  If you prefer the more traditional color mode you can specify `color.mode="rgb"` in the parameter list, or use `options(diffobj.color.mode="rgb")`:

```{r, results="asis"}
diffChr(x, y, color.mode="rgb")
```

### Output Formats

If your terminal supports it `diffobj` will format with ANSI escape sequences.  `diffobj` uses Gabor Csardi's `[crayon](https://github.com/gaborcsardi/crayon)` crayon to detect ANSI support and to apply ANSI based formatting.  If your terminal does not support colors, `diffobj` will attempt to output an HTML/CSS formatted diff to your browser using `browseURL`.

You can specify the output format with the `format` parameter set to:

* "raw" for unformatted diffs
* "ansi8" for standard ANSI 8 color formatting
* "ans256" for ANSI 256 color formatting
* "html" for HTML/CSS output and styling

### Brightness

By default, this parameter is really only meaningful for the "ansi256" format, but could be useful under other formats if you build custom styles.  It allows you to pick a color scheme compatible with the background color of your terminal.  The options are:

* "light": for use with light tone terminals
* "dark": for use with dark tone terminals
* "neutral": for use with either light or dark terminals

Here are examples of terminal screen renderings for both "rgb" and "yb" `color.mode` for the three `brightness` levels.

<img src="ansi256brightness.png"></img>

The examples for "light" and "dark" have the backgrounds forcefully set to a color compatible with the scheme.  In actual use the base background and foreground colors are left unchanged, which will look bad if you use "dark" with light colored backgrounds or vice versa.  Since we do not know of a good cross platform way of detecting terminal background color the default `brightness` value is "neutral".

At this time the only `format` that is affected by this parameter is `brightness`.  If you want to specify your own light/dark/neutral schemes you may do so either by specifying a `[style](#custom-styles)` directly or with `[Palette of Styles](#custom-styles)` (see next section).

### Pagers

If the diff output is very long `diff*` methods will pipe output to a pager. The default action is to create a temporary file with the diff output, and feed that to `file.show`.  If your terminal does not support ANSI escape sequences, the default action is to use your web browser as a pager / terminal irrespective of how big the actual output is.

You can fine tune when, how, and if a pager is used by 
## Algorithm

The diff algorithm is Myer's solution to the shortest edit script /
longest common sequence problem with the Hirschberg linear space refinement
as described in:
> E. Myers, "An O(ND) Difference Algorithm and Its Variations",
Algorithmica 1, 2 (1986), 251-266.
\url{http://www.cs.arizona.edu/people/gene/PAPERS/diff.ps}

and should be the same algorithm used by GNU diff.  The implementation
used here is an adaptation of Michael B. Allen's diff program from the
[`libmba`](http://www.ioplex.com/~miallen/libmba/dl/libmba-0.9.1.tar.gz) `C` library.

This algorithm scales with the _square_ of the number of differences
between compared objects so is most effective when comparing objects
that are mostly similar.

## Acknowledgements

* Myers
* MBA
* Gabor
